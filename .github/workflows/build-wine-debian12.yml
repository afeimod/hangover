name: deb-wine-debian12

on:
  workflow_dispatch:
  push:
    branches:
      - '**'
    paths-ignore:
      - 'benchmarks/**'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - 'README.md'
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.sha }}
  cancel-in-progress: false

jobs:
  foundations-debian12:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [debian12]

    steps:
    - uses: actions/checkout@v1
    - name: free disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        df -h

    - name: Cache docker image
      id: cache-foundation
      uses: actions/cache@v4
      env:
        cache-name: cache-foundation
      with:
        path: foundation${{ matrix.os }}.tgz
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles(format('.packaging/{0}/Dockerfile', matrix.os)) }}
        lookup-only: true

    - name: Setup packaging
      if: ${{ steps.cache-foundation.outputs.cache-hit != 'true' }}
      run: |
        cp .packaging/${{ matrix.os }}/Dockerfile .

    - name: Build package
      if: ${{ steps.cache-foundation.outputs.cache-hit != 'true' }}
      run: docker build -t foundation${{ matrix.os }} .

    - name: Export docker image
      if: ${{ steps.cache-foundation.outputs.cache-hit != 'true' }}
      run: docker image save foundation${{ matrix.os }} | gzip -c > foundation${{ matrix.os }}.tgz

  wine-debian12:
    needs: foundations-debian12
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: free disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        df -h

    - name: Cache docker image
      id: cache-foundation
      uses: actions/cache@v4
      env:
        cache-name: cache-foundation
      with:
        path: foundationdebian12.tgz
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('.packaging/debian12/Dockerfile') }}

    - name: Import docker image
      run: docker image load -i foundationdebian12.tgz

    - name: get hangover version
      run: |
        HOVERSION=$(git describe --tags | sed 's/hangover-//')
        echo "HOVERSION=$HOVERSION" >> $GITHUB_ENV
        echo "Hangover version: $HOVERSION"
        
        # 尝试从 hangover 版本中提取 wine 版本
        # 格式可能是: 0.9.0-wine-9.10 或 0.9.0 等
        if [[ "$HOVERSION" =~ wine-([0-9]+\.[0-9]+) ]]; then
          WINE_VERSION_FROM_HO="${BASH_REMATCH[1]}"
          echo "Extracted wine version from hangover: $WINE_VERSION_FROM_HO"
          echo "WINE_VERSION_FROM_HO=$WINE_VERSION_FROM_HO" >> $GITHUB_ENV
        else
          echo "No wine version found in hangover version string"
          echo "WINE_VERSION_FROM_HO=" >> $GITHUB_ENV
        fi

    - name: get shallow submodule
      run: git submodule update --init --recursive --depth 1 wine

    - name: Check wine source and get wine version
      run: |
        cd wine
        
        echo "Checking wine repository URL..."
        git remote -v
        
        echo "Getting wine version from AndreRH/wine repository..."
        
        # 方法1: 从 git 标签获取
        WINE_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        # 方法2: 从 configure.ac 获取
        if [ -f "configure.ac" ]; then
          WINE_MAJOR=$(grep -m1 "define(\[WINE_MAJOR_VERSION\]," configure.ac | tr -d '[]' | awk -F, '{print $2}' | tr -d ' )')
          WINE_MINOR=$(grep -m1 "define(\[WINE_MINOR_VERSION\]," configure.ac | tr -d '[]' | awk -F, '{print $2}' | tr -d ' )')
          WINE_VERSION_FROM_CONFIGURE="${WINE_MAJOR}.${WINE_MINOR}"
          echo "Version from configure.ac: $WINE_VERSION_FROM_CONFIGURE"
        else
          WINE_VERSION_FROM_CONFIGURE=""
        fi
        
        # 方法3: 从 VERSION 文件获取
        if [ -f "VERSION" ]; then
          WINE_VERSION_FROM_FILE=$(cat VERSION | sed 's/^wine-//i' | head -1)
          echo "Version from VERSION file: $WINE_VERSION_FROM_FILE"
        else
          WINE_VERSION_FROM_FILE=""
        fi
        
        # 优先使用从 hangover 版本中提取的 wine 版本
        if [ -n "${{ env.WINE_VERSION_FROM_HO }}" ]; then
          WINE_VERSION="${{ env.WINE_VERSION_FROM_HO }}"
          echo "Using wine version from hangover: $WINE_VERSION"
        # 其次使用从标签中提取的版本
        elif [ -n "$WINE_TAG" ]; then
          WINE_VERSION=$(echo "$WINE_TAG" | sed 's/^wine-//i' | sed 's/^WINE-//i')
          echo "Using wine version from tag: $WINE_VERSION"
        # 然后使用 configure.ac 中的版本
        elif [ -n "$WINE_VERSION_FROM_CONFIGURE" ]; then
          WINE_VERSION="$WINE_VERSION_FROM_CONFIGURE"
          echo "Using wine version from configure.ac: $WINE_VERSION"
        # 最后使用 VERSION 文件中的版本
        elif [ -n "$WINE_VERSION_FROM_FILE" ]; then
          WINE_VERSION="$WINE_VERSION_FROM_FILE"
          echo "Using wine version from VERSION file: $WINE_VERSION"
        else
          WINE_VERSION="8.0"  # 默认值
          echo "Using default wine version: $WINE_VERSION"
        fi
        
        # 提取主次版本
        VERSION_MAJOR=$(echo "$WINE_VERSION" | cut -d. -f1)
        VERSION_MINOR=$(echo "$WINE_VERSION" | cut -d. -f2)
        
        echo "WINE_VERSION=$WINE_VERSION" >> $GITHUB_ENV
        echo "WINE_VERSION_MAJOR=$VERSION_MAJOR" >> $GITHUB_ENV
        echo "WINE_VERSION_MINOR=$VERSION_MINOR" >> $GITHUB_ENV
        
        echo "Final wine version: $WINE_VERSION"
        echo "Major: $VERSION_MAJOR, Minor: $VERSION_MINOR"
        
        # 保存 wine tag 信息
        if [ -n "$WINE_TAG" ]; then
          echo "WINE_TAG=$WINE_TAG" >> $GITHUB_ENV
        else
          echo "WINE_TAG=unknown" >> $GITHUB_ENV
        fi

    - name: Setup packaging
      run: |
        cp -r .packaging/debian12/wine/* wine
        sed -i "s/HOVERSION/${{ env.HOVERSION }}/g" wine/Dockerfile
        nproc

    - name: Apply version-specific patches based on wine version
      run: |
        cd wine
        
        echo "Applying patches based on wine version: ${{ env.WINE_VERSION }}"
        echo "Hangover version: ${{ env.HOVERSION }}"
        echo "Wine version major: ${{ env.WINE_VERSION_MAJOR }}, minor: ${{ env.WINE_VERSION_MINOR }}"
        
        # 判断版本是否 >= 9.10
        if [ "${{ env.WINE_VERSION_MAJOR }}" -gt 9 ] || [ "${{ env.WINE_VERSION_MAJOR }}" -eq 9 -a "${{ env.WINE_VERSION_MINOR }}" -ge 10 ]; then
          echo "Wine version >= 9.10, applying wine_do_not_create_dxgi_manager2.patch"
          wget -O wine_do_not_create_dxgi_manager2.patch https://github.com/afeimod/linbox/raw/main/path/wine_do_not_create_dxgi_manager2.patch
          if [ -f wine_do_not_create_dxgi_manager2.patch ]; then
            echo "Applying 9.10+ patch..."
            patch -p1 < wine_do_not_create_dxgi_manager2.patch || echo "Patch application failed or already applied"
          else
            echo "Failed to download 9.10+ patch"
          fi
        else
          echo "Wine version < 9.10, applying fix_wine9.2_mfplat.sh"
          wget -O fix_wine9.2_mfplat.sh https://github.com/afeimod/linbox/raw/main/path/fix_wine9.2_mfplat.sh
          chmod +x fix_wine9.2_mfplat.sh
          echo "Applying < 9.10 fix..."
          ./fix_wine9.2_mfplat.sh || echo "Fix script execution failed or already applied"
        fi
        
        # 根据 hangover 版本决定是否应用额外补丁
        echo "Checking hangover version for additional patches..."
        HOVERSION="${{ env.HOVERSION }}"
        
        # 如果 hangover 版本包含特定标记，应用额外补丁
        if [[ "$HOVERSION" == *"staging"* ]]; then
          echo "Hangover version indicates staging, applying additional staging patches..."
          # 这里可以添加针对 staging 的额外补丁
        fi
        
        if [[ "$HOVERSION" == *"proton"* ]]; then
          echo "Hangover version indicates proton, applying proton-specific patches..."
          # 这里可以添加针对 proton 的额外补丁
        fi

    - name: Download and apply wine staging patches
      run: |
        cd wine
        
        WINE_VERSION="${{ env.WINE_VERSION }}"
        echo "Attempting to download staging patches for wine version: $WINE_VERSION"
        echo "Using wine version from: ${{ env.WINE_TAG }}"
        
        # 清理可能的旧文件
        rm -f wine-staging-*.tar.gz
        
        # 首先尝试使用标准版本格式
        echo "Trying standard version formats..."
        
        # 尝试不同的 staging 版本格式
        STAGING_VERSION_FORMATS=(
          "v$WINE_VERSION"
          "$WINE_VERSION"
          "v${WINE_VERSION}.0"
          "${WINE_VERSION}.0"
        )
        
        STAGING_DOWNLOADED=false
        
        for STAGING_VERSION in "${STAGING_VERSION_FORMATS[@]}"; do
          echo "Trying staging version: $STAGING_VERSION"
          
          # 尝试下载 staging 补丁
          if wget -q "https://github.com/wine-staging/wine-staging/archive/refs/tags/${STAGING_VERSION}.tar.gz" -O "wine-staging-${WINE_VERSION}.tar.gz"; then
            echo "Successfully downloaded staging patch for version $STAGING_VERSION"
            STAGING_DOWNLOADED=true
            break
          fi
        done
        
        # 如果标准格式失败，尝试从 wine-staging 发布页面查找最近的版本
        if [ "$STAGING_DOWNLOADED" = false ]; then
          echo "Standard version formats failed, trying to find closest staging version..."
          
          # 获取 wine-staging 的所有标签
          echo "Fetching wine-staging tags..."
          STAGING_TAGS=$(curl -s https://api.github.com/repos/wine-staging/wine-staging/tags | grep -o '"name": "[^"]*"' | cut -d'"' -f4 | head -20)
          
          echo "Available staging tags (top 20):"
          echo "$STAGING_TAGS"
          
          # 寻找最接近的版本
          for TAG in $STAGING_TAGS; do
            # 提取纯数字版本
            TAG_VERSION=$(echo "$TAG" | sed 's/^v//' | grep -Eo '[0-9]+\.[0-9]+' | head -1)
            
            if [ -n "$TAG_VERSION" ]; then
              echo "Checking tag $TAG with version $TAG_VERSION"
              
              # 如果版本匹配或接近，尝试下载
              if [ "$TAG_VERSION" = "$WINE_VERSION" ] || \
                 [ "$TAG_VERSION" = "${WINE_VERSION%.*}" ]; then
                echo "Found matching tag: $TAG"
                if wget -q "https://github.com/wine-staging/wine-staging/archive/refs/tags/${TAG}.tar.gz" -O "wine-staging-${WINE_VERSION}.tar.gz"; then
                  echo "Successfully downloaded staging patch for tag $TAG"
                  STAGING_DOWNLOADED=true
                  break
                fi
              fi
            fi
          done
        fi
        
        if [ "$STAGING_DOWNLOADED" = true ]; then
          echo "Extracting staging patches..."
          tar -xzf "wine-staging-${WINE_VERSION}.tar.gz"
          
          # 查找解压后的 staging 目录
          STAGING_DIR=$(find . -maxdepth 1 -type d -name "*staging*" | head -1)
          
          if [ -n "$STAGING_DIR" ] && [ -d "$STAGING_DIR/staging" ]; then
            echo "Found staging directory: $STAGING_DIR"
            
            # 进入 staging 目录并应用补丁
            cd "$STAGING_DIR/staging"
            
            if [ -f "patchinstall.py" ]; then
              chmod +x patchinstall.py
              
              echo "Applying staging patches..."
              # 尝试应用所有补丁，允许部分失败
              if python3 patchinstall.py --all --destdir=../../ --no-autoconf; then
                echo "Staging patches applied successfully"
              else
                echo "Some patches failed, trying with force flag..."
                python3 patchinstall.py --all --destdir=../../ --no-autoconf --force || \
                echo "Some staging patches may have failed to apply"
              fi
              
              echo "Staging patches application completed"
            else
              echo "Error: patchinstall.py not found in staging directory"
            fi
            
            # 返回到 wine 目录
            cd ../..
          else
            echo "Warning: Could not find staging directory structure after extraction"
            echo "Current directory contents:"
            ls -la
          fi
        else
          echo "Warning: Could not download staging patches for wine version $WINE_VERSION"
          echo "Continuing without staging patches"
          
          # 检查 hangover 版本是否包含 staging，如果是，记录警告
          HOVERSION="${{ env.HOVERSION }}"
          if [[ "$HOVERSION" == *"staging"* ]]; then
            echo "Note: Hangover version indicates staging but no staging patches were found for wine $WINE_VERSION"
          fi
        fi

    - name: Adjust changelog for intermediate
      if: github.event_name != 'release'
      run: |
        cp wine/debian/changelog wine/debian/changelog.old
        echo "hangover-wine (${{ env.HOVERSION }}~bookworm) UNRELEASED; urgency=low" > wine/debian/changelog.entry
        echo "" >> wine/debian/changelog.entry
        echo "  * Intermediate build ${{ env.HOVERSION }}~bookworm" >> wine/debian/changelog.entry
        echo "  * Built with wine version ${{ env.WINE_VERSION }}" >> wine/debian/changelog.entry
        echo "" >> wine/debian/changelog.entry
        echo -n " -- André Zwing <nerv@dawncrow.de>  " >> wine/debian/changelog.entry
        LC_TIME=en_US.UTF-8 date "+%a, %d %b %Y %H:%M:%S %z" >> wine/debian/changelog.entry
        echo "" >> wine/debian/changelog.entry
        cat wine/debian/changelog.entry wine/debian/changelog.old > wine/debian/changelog
        rm wine/debian/changelog.entry wine/debian/changelog.old
        cat wine/debian/changelog

    - name: Adjust changelog for release
      if: github.event_name == 'release'
      run: |
        cp wine/debian/changelog wine/debian/changelog.old
        echo "hangover-wine (${{ env.HOVERSION }}~bookworm) UNRELEASED; urgency=low" > wine/debian/changelog.entry
        echo "" >> wine/debian/changelog.entry
        echo "  * Release ${{ env.HOVERSION }}~bookworm" >> wine/debian/changelog.entry
        echo "  * Built with wine version ${{ env.WINE_VERSION }}" >> wine/debian/changelog.entry
        echo "" >> wine/debian/changelog.entry
        echo -n " -- André Zwing <nerv@dawncrow.de>  " >> wine/debian/changelog.entry
        LC_TIME=en_US.UTF-8 date "+%a, %d %b %Y %H:%M:%S %z" >> wine/debian/changelog.entry
        echo "" >> wine/debian/changelog.entry
        cat wine/debian/changelog.entry wine/debian/changelog.old > wine/debian/changelog
        rm wine/debian/changelog.entry wine/debian/changelog.old
        cat wine/debian/changelog

    - name: Build package
      run: cd wine; docker build -t wine-debian12 .

    - name: Extract package
      run: docker run --rm wine-debian12 cat /opt/hangover-wine_${{ env.HOVERSION }}~bookworm_arm64.deb > hangover-wine_${{ env.HOVERSION }}~bookworm_arm64.deb

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: hangover-wine_${{ env.HOVERSION }}~bookworm_arm64.deb
        path: hangover-wine_${{ env.HOVERSION }}~bookworm_arm64.deb