name: deb-debian12

on:
  workflow_dispatch:
  push:
    branches:
      - '**'
    paths-ignore:
      - 'benchmarks/**'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - 'README.md'
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.sha }}
  cancel-in-progress: false

jobs:
  foundations-debian12:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [debian12]

    steps:
    - uses: actions/checkout@v1
    - name: free disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        df -h

    - name: Cache docker image
      id: cache-foundation
      uses: actions/cache@v4
      env:
        cache-name: cache-foundation
      with:
        path: foundation${{ matrix.os }}.tgz
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles(format('.packaging/{0}/Dockerfile', matrix.os)) }}
        lookup-only: true

    - name: Setup packaging
      if: ${{ steps.cache-foundation.outputs.cache-hit != 'true' }}
      run: |
        cp .packaging/${{ matrix.os }}/Dockerfile .

    - name: Build package
      if: ${{ steps.cache-foundation.outputs.cache-hit != 'true' }}
      run: docker build -t foundation${{ matrix.os }} .

    - name: Export docker image
      if: ${{ steps.cache-foundation.outputs.cache-hit != 'true' }}
      run: docker image save foundation${{ matrix.os }} | gzip -c > foundation${{ matrix.os }}.tgz

  wine-debian12:
    needs: foundations-debian12
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: free disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        df -h

    - name: Cache docker image
      id: cache-foundation
      uses: actions/cache@v4
      env:
        cache-name: cache-foundation
      with:
        path: foundationdebian12.tgz
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('.packaging/debian12/Dockerfile') }}

    - name: Import docker image
      run: docker image load -i foundationdebian12.tgz

    - name: get version
      run: git describe --tags | sed "s/hangover-/HOVERSION=/" >> "$GITHUB_ENV"; git describe --tags | sed "s/hangover-/HOVERSION=/"

    - name: get shallow submodule
      run: git submodule update --init --recursive --depth 1 wine

    - name: Setup packaging
      run: |
        cp -r .packaging/debian12/wine/* wine
        sed -i "s/HOVERSION/${HOVERSION}/g" wine/Dockerfile
        nproc

    - name: Apply wine patch
      run: |
        cd wine
        wget -O wine_do_not_create_dxgi_manager2.patch https://github.com/afeimod/linbox/raw/main/path/wine_do_not_create_dxgi_manager2.patch
        if [ -f wine_do_not_create_dxgi_manager2.patch ]; then
          patch -p1 < wine_do_not_create_dxgi_manager2.patch || echo "Patch application failed or already applied"
        else
          echo "Failed to download patch"
        fi

    - name: Apply wine staging patch based on version
      run: |
        cd wine
        # 获取 hangover 版本号
        HOVERSION="${{ env.HOVERSION }}"
        echo "Hangover version: $HOVERSION"
        
        # 从 hangover 版本号中提取 wine 版本号
        # 假设版本格式为: x.x.x-wine-x.x
        # 或者从 git submodule 获取 wine 的实际版本
        WINE_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$WINE_VERSION" ]; then
          # 尝试从 hangover 版本中提取
          if [[ "$HOVERSION" =~ wine-([0-9]+\.[0-9]+) ]]; then
            WINE_VERSION="${BASH_REMATCH[1]}"
            echo "Extracted wine version from hangover: $WINE_VERSION"
          else
            # 尝试从 wine 子模块获取
            WINE_VERSION=$(cd wine && git describe --tags --abbrev=0 2>/dev/null | sed 's/wine-//' || echo "")
            if [ -z "$WINE_VERSION" ]; then
              WINE_VERSION="9.0"  # 默认值
              echo "Using default wine version: $WINE_VERSION"
            fi
          fi
        fi
        
        echo "Detected wine version: $WINE_VERSION"
        
        # 从版本号中提取主次版本
        VERSION_MAJOR=$(echo "$WINE_VERSION" | cut -d. -f1)
        VERSION_MINOR=$(echo "$WINE_VERSION" | cut -d. -f2)
        
        echo "Wine major version: $VERSION_MAJOR, minor version: $VERSION_MINOR"
        
        # 判断版本是否 >= 9.10
        if [ "$VERSION_MAJOR" -gt 9 ] || [ "$VERSION_MAJOR" -eq 9 -a "$VERSION_MINOR" -ge 10 ]; then
          echo "Using 9.10+ version fix (wine_do_not_create_dxgi_manager2.patch)"
          # 已经在上一步应用了，这里确保补丁已应用
          if [ -f wine_do_not_create_dxgi_manager2.patch ]; then
            echo "9.10+ patch already applied or available"
          fi
        else
          echo "Using < 9.10 version fix (fix_wine9.2_mfplat.sh)"
          wget -O fix_wine9.2_mfplat.sh https://github.com/afeimod/linbox/raw/main/path/fix_wine9.2_mfplat.sh
          chmod +x fix_wine9.2_mfplat.sh
          ./fix_wine9.2_mfplat.sh || echo "Fix script execution failed or already applied"
        fi
        
        # 下载并应用 staging 补丁
        echo "Downloading and applying staging patches for wine version $WINE_VERSION..."
        
        # 尝试不同的版本格式
        STAGING_VERSIONS=("v$WINE_VERSION" "$WINE_VERSION")
        
        for STAGING_VERSION in "${STAGING_VERSIONS[@]}"; do
          echo "Trying staging version: $STAGING_VERSION"
          
          # 下载 staging 补丁
          if wget -O "wine-staging-${WINE_VERSION}.tar.gz" "https://github.com/wine-staging/wine-staging/archive/refs/tags/${STAGING_VERSION}.tar.gz"; then
            echo "Successfully downloaded staging patch for version $STAGING_VERSION"
            break
          fi
        done
        
        if [ -f "wine-staging-${WINE_VERSION}.tar.gz" ]; then
          echo "Extracting staging patches..."
          tar -xzf "wine-staging-${WINE_VERSION}.tar.gz"
          
          # 查找解压后的 staging 目录
          STAGING_DIR=$(find . -maxdepth 1 -type d -name "*staging*" | head -1)
          
          if [ -n "$STAGING_DIR" ] && [ -d "$STAGING_DIR/staging" ]; then
            echo "Found staging directory: $STAGING_DIR"
            cd "$STAGING_DIR/staging"
            chmod +x patchinstall.py
            
            echo "Applying staging patches..."
            # 应用所有补丁，跳过可能失败的部分
            ./patchinstall.py --all --destdir=../../ --no-autoconf || \
            ./patchinstall.py --all --destdir=../../ --no-autoconf --force || \
            echo "Some patches may have failed to apply"
            
            cd ../..
            echo "Staging patches applied"
          else
            echo "Warning: Could not find staging directory structure"
            echo "Directory contents:"
            ls -la
          fi
        else
          echo "Warning: Could not download staging patches for wine version $WINE_VERSION"
          echo "Continuing without staging patches"
        fi

    - name: Adjust changelog for intermediate
      if: github.event_name != 'release'
      run: |
        cp wine/debian/changelog wine/debian/changelog.old
        echo "hangover-wine (${HOVERSION}~bookworm) UNRELEASED; urgency=low" > wine/debian/changelog.entry
        echo "" >> wine/debian/changelog.entry
        echo "  * Intermediate build ${HOVERSION}~bookworm" >> wine/debian/changelog.entry
        echo "" >> wine/debian/changelog.entry
        echo -n " -- André Zwing <nerv@dawncrow.de>  " >> wine/debian/changelog.entry
        LC_TIME=en_US.UTF-8 date "+%a, %d %b %Y %H:%M:%S %z" >> wine/debian/changelog.entry
        echo "" >> wine/debian/changelog.entry
        cat wine/debian/changelog.entry wine/debian/changelog.old > wine/debian/changelog
        rm wine/debian/changelog.entry wine/debian/changelog.old
        cat wine/debian/changelog

    - name: Adjust changelog for release
      if: github.event_name == 'release'
      run: |
        cp wine/debian/changelog wine/debian/changelog.old
        echo "hangover-wine (${HOVERSION}~bookworm) UNRELEASED; urgency=low" > wine/debian/changelog.entry
        echo "" >> wine/debian/changelog.entry
        echo "  * Release ${HOVERSION}~bookworm" >> wine/debian/changelog.entry
        echo "" >> wine/debian/changelog.entry
        echo -n " -- André Zwing <nerv@dawncrow.de>  " >> wine/debian/changelog.entry
        LC_TIME=en_US.UTF-8 date "+%a, %d %b %Y %H:%M:%S %z" >> wine/debian/changelog.entry
        echo "" >> wine/debian/changelog.entry
        cat wine/debian/changelog.entry wine/debian/changelog.old > wine/debian/changelog
        rm wine/debian/changelog.entry wine/debian/changelog.old
        cat wine/debian/changelog

    - name: Build package
      run: cd wine; docker build -t wine-debian12 .

    - name: Extract package
      run: docker run --rm wine-debian12 cat /opt/hangover-wine_${{ env.HOVERSION }}~bookworm_arm64.deb > hangover-wine_${{ env.HOVERSION }}~bookworm_arm64.deb

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: hangover-wine_${{ env.HOVERSION }}~bookworm_arm64.deb
        path: hangover-wine_${{ env.HOVERSION }}~bookworm_arm64.deb