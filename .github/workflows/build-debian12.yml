name: Build Proton Wine for Debian 12 ARM64

on:
  workflow_dispatch:
    inputs:
      proton_branch:
        description: 'Proton branch (e.g., proton_10.0, proton_9.0)'
        required: true
        default: 'proton_10.0'
      rebuild_foundation:
        description: 'Rebuild foundation Docker image'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - 'main'
      - 'proton/**'
    tags:
      - 'proton-*'
  release:
    types: [published]

env:
  DISTRO_NAME: debian12
  DISTRO_CODENAME: bookworm
  ARCH: arm64
  BUILD_DIR: /tmp/proton-build
  INSTALL_DIR: /tmp/proton-install
  LLVMMINGW_DATE: 20251202
  LLVMMINGW_NAME: llvm-mingw-20251202-ucrt-ubuntu-22.04-x86_64

jobs:
  build-proton:
    runs-on: ubuntu-24.04-arm
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: Free up disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        docker system prune -f || true
        df -h
        
    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential \
          debhelper \
          devscripts \
          equivs \
          git \
          wget \
          curl \
          ca-certificates \
          gnupg \
          lsb-release \
          pkg-config \
          cmake \
          ninja-build \
          qemu-user-static \
          binfmt-support
        
        docker --version
        
    - name: Get Hangover version
      id: get_version
      run: |
        if git describe --tags --exact-match 2>/dev/null; then
          VERSION=$(git describe --tags | sed 's/^hangover-//')
        else
          VERSION="0.0.0~$(git rev-parse --short HEAD)"
        fi
        echo "HOVERSION=${VERSION}" >> $GITHUB_ENV
        echo "Using version: ${VERSION}"
        
    - name: Create Dockerfile for Debian 12 ARM64
      run: |
        mkdir -p .docker/debian12
        
        cat > .docker/debian12/Dockerfile << EOF
        FROM debian:12

        ARG LLVMMINGW_DATE=20251202
        ARG LLVMMINGW_NAME=llvm-mingw-\${LLVMMINGW_DATE}-ucrt-ubuntu-22.04-x86_64

        ENV DEBIAN_FRONTEND=noninteractive
        ENV LANG=C.UTF-8
        ENV LC_ALL=C.UTF-8
        ENV BUILD_JOBS=\$(nproc)
        
        # 设置多架构支持
        RUN echo "deb [arch=amd64,arm64] http://deb.debian.org/debian bookworm main contrib non-free" > /etc/apt/sources.list && \
            echo "deb [arch=amd64,arm64] http://deb.debian.org/debian bookworm-updates main contrib non-free" >> /etc/apt/sources.list && \
            echo "deb [arch=amd64,arm64] http://security.debian.org/debian-security bookworm-security main contrib non-free" >> /etc/apt/sources.list
        
        RUN dpkg --add-architecture arm64 && \
            apt-get update && apt-get install -y --no-install-recommends \
            ca-certificates \
            wget \
            curl \
            git \
            make \
            automake \
            autoconf \
            pkg-config \
            libtool \
            cmake \
            ninja-build \
            gcc \
            g++ \
            clang \
            llvm \
            lld \
            flex \
            bison \
            nasm \
            yasm \
            gettext \
            python3 \
            python3-setuptools \
            perl \
            ruby \
            patchelf \
            meson
        
        # 安装ARM64原生构建工具
        RUN apt-get install -y --no-install-recommends \
            binutils-aarch64-linux-gnu \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            libc-dev-arm64-cross \
            libstdc++6-arm64-cross \
            libstdc++-12-dev-arm64-cross \
            build-essential \
            dpkg-dev \
            fakeroot \
            debhelper \
            dh-make
        
        # 安装Wine/Proton构建所需的ARM64库
        RUN apt-get install -y --no-install-recommends \
            libfreetype6-dev:arm64 \
            libglib2.0-dev:arm64 \
            libltdl-dev:arm64 \
            libxcb1-dev:arm64 \
            libx11-dev:arm64 \
            libxinerama-dev:arm64 \
            libxcursor-dev:arm64 \
            libxi-dev:arm64 \
            libxrandr-dev:arm64 \
            libxrender-dev:arm64 \
            libxfixes-dev:arm64 \
            libxcomposite-dev:arm64 \
            libxdamage-dev:arm64 \
            libxxf86vm-dev:arm64 \
            libxshmfence-dev:arm64 \
            libdbus-1-dev:arm64 \
            libsane-dev:arm64 \
            libusb-1.0-0-dev:arm64 \
            libv4l-dev:arm64 \
            libpulse-dev:arm64 \
            libgstreamer1.0-dev:arm64 \
            libgstreamer-plugins-base1.0-dev:arm64 \
            libgstreamer-plugins-bad1.0-dev:arm64 \
            libudev-dev:arm64 \
            libunwind-dev:arm64 \
            libsdl2-dev:arm64 \
            libfontconfig1-dev:arm64 \
            libkrb5-dev:arm64 \
            libvulkan-dev:arm64 \
            libgl-dev:arm64 \
            libgnutls28-dev:arm64 \
            libcups2-dev:arm64 \
            libxkbcommon-dev:arm64 \
            libxkbregistry-dev:arm64 \
            libwayland-dev:arm64 \
            libepoxy-dev:arm64 \
            libssl-dev:arm64 \
            libmpg123-dev:arm64 \
            libopenal-dev:arm64 \
            libpcap-dev:arm64 \
            libosmesa6-dev:arm64 \
            libjpeg-dev:arm64 \
            libpng-dev:arm64 \
            libtiff-dev:arm64 \
            libxml2-dev:arm64 \
            mesa-vulkan-drivers:arm64 \
            libgettextpo-dev:arm64
        
        # 安装mingw-w64工具链
        RUN apt-get install -y --no-install-recommends \
            mingw-w64 \
            mingw-w64-tools \
            mingw-w64-common \
            mingw-w64-i686-dev \
            mingw-w64-x86-64-dev \
            gcc-mingw-w64 \
            g++-mingw-w64
        
        # 下载和安装llvm-mingw（ARM64 Windows交叉编译工具链）
        RUN mkdir -p /opt/llvm-mingw && cd /opt && \
            wget -q https://github.com/mstorsjo/llvm-mingw/releases/download/\${LLVMMINGW_DATE}/\${LLVMMINGW_NAME}.tar.xz && \
            tar -xJf \${LLVMMINGW_NAME}.tar.xz && \
            mv \${LLVMMINGW_NAME} llvm-mingw && \
            rm \${LLVMMINGW_NAME}.tar.xz
        
        # 设置环境变量
        ENV PATH="/opt/llvm-mingw/bin:\$PATH"
        ENV CC="gcc"
        ENV CXX="g++"
        ENV AR="ar"
        ENV STRIP="strip"
        
        # 设置交叉编译环境变量
        ENV CROSSCC="clang"
        ENV CROSSCXX="clang++"
        ENV CROSSAR="llvm-ar"
        ENV CROSSLD="lld"
        ENV CROSSRC="llvm-rc"
        ENV CROSSSTRIP="llvm-strip"
        
        # ARM64 Windows交叉编译工具
        ENV CC_aarch64_w64_mingw32="clang"
        ENV CXX_aarch64_w64_mingw32="clang++"
        ENV AR_aarch64_w64_mingw32="llvm-ar"
        ENV STRIP_aarch64_w64_mingw32="llvm-strip"
        ENV RC_aarch64_w64_mingw32="llvm-rc"
        
        # 创建构建用户
        # 安装 sudo 并创建构建用户
        RUN apt-get update && apt-get install -y sudo && \
            useradd -m -s /bin/sh builder && \
            echo "builder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/builder && \
            chmod 0440 /etc/sudoers.d/builder
        
        USER builder
        WORKDIR /home/builder
        
        CMD ["/bin/sh"]
        EOF
        
        echo "Dockerfile created at .docker/debian12/Dockerfile"
        
    - name: Build or load foundation Docker image
      id: foundation
      run: |
        if [ "${{ github.event.inputs.rebuild_foundation }}" = "true" ]; then
          echo "Forcing rebuild of foundation image..."
          rm -f foundation-debian12-arm64.tar.gz 2>/dev/null || true
        fi
        
        if [ -f "foundation-debian12-arm64.tar.gz" ]; then
          echo "Loading foundation image from cache..."
          docker load -i foundation-debian12-arm64.tar.gz
          echo "foundation_image=foundation-debian12-arm64" >> $GITHUB_OUTPUT
        else
          echo "Building foundation Docker image..."
          docker build \
            --build-arg LLVMMINGW_DATE=20251202 \
            -t foundation-debian12-arm64 .docker/debian12
          
          docker save foundation-debian12-arm64 | gzip > foundation-debian12-arm64.tar.gz
          echo "foundation_image=foundation-debian12-arm64" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Proton build script
      run: |
        mkdir -p proton-build
        
        cat > proton-build/build-proton.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # 参数
        PROTON_BRANCH=${1:-proton_10.0}
        HOVERSION=${2:-0.0.0}
        CODENAME=${3:-bookworm}
        ARCH=${4:-arm64}
        
        echo "================================================"
        echo "Building Proton Wine for Debian 12 ARM64"
        echo "Proton branch: ${PROTON_BRANCH}"
        echo "Hangover version: ${HOVERSION}"
        echo "Codename: ${CODENAME}"
        echo "Architecture: ${ARCH}"
        echo "================================================"
        
        # 清理旧的构建
        rm -rf ${BUILD_DIR} ${INSTALL_DIR}
        mkdir -p ${BUILD_DIR} ${INSTALL_DIR}
        
        cd ${BUILD_DIR}
        
        # 克隆 Proton Wine 源码
        echo "Cloning Proton Wine source..."
        git clone https://github.com/ValveSoftware/wine
        cd wine
        
        # 切换到指定的 Proton 分支
        echo "Checking out branch: ${PROTON_BRANCH}"
        git checkout ${PROTON_BRANCH}
        
        # 获取实际的 Proton 版本
        PROTON_VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^proton_//' || echo "${PROTON_BRANCH}")
        echo "Proton version: ${PROTON_VERSION}"
        
        # 生成 configure 脚本
        echo "生成 configure 脚本..."
        ./autogen.sh
        
        # 创建构建目录
        mkdir -p build
        cd build
        
        # 设置编译标志
        export CFLAGS="-O2 -pipe -march=armv8-a -mtune=cortex-a76 -fno-stack-protector"
        export CXXFLAGS="-O2 -pipe -march=armv8-a -mtune=cortex-a76 -fno-stack-protector"
        export LDFLAGS="-Wl,-Bsymbolic-functions -Wl,-z,relro"
        
        # 设置交叉编译环境变量
        export CC="gcc"
        export CXX="g++"
        export CROSSCC="clang"
        export CROSSCXX="clang++"
        export CROSSAR="llvm-ar"
        export CROSSLD="lld"
        export CROSSRC="llvm-rc"
        export CROSSSTRIP="llvm-strip"
        
        # 设置ARM64 Windows交叉编译工具
        export CC_aarch64_w64_mingw32="clang"
        export CXX_aarch64_w64_mingw32="clang++"
        export AR_aarch64_w64_mingw32="llvm-ar"
        export STRIP_aarch64_w64_mingw32="llvm-strip"
        export RC_aarch64_w64_mingw32="llvm-rc"
        
        # 运行配置脚本
        echo "Configuring Proton Wine..."
        ../configure \
            --prefix=/usr \
            --enable-win64 \
            --disable-win16 \
            --disable-tests \
            --with-x \
            --with-vulkan \
            --with-pulse \
            --with-sdl \
            --with-cups \
            --with-gstreamer \
            --enable-archs="x86_64,aarch64" \
            --host=aarch64-linux-gnu \
            --enable-nls \
            --disable-winemenubuilder \
            --without-ldap \
            --without-capi \
            --without-oss \
            --without-cups \
            --without-dbus \
            --without-coreaudio \
            --without-gphoto \
            --without-osmesa \
            --without-sane \
            --without-pcap \
            --without-pcsclite \
            --without-udev \
            --without-unwind \
            --without-usb \
            --without-v4l2 \
            --without-wayland \
            --build=aarch64-linux-gnu
        
        # 构建
        echo "Building Proton Wine..."
        make -j$(nproc)
        
        # 安装到临时目录
        echo "Installing to temporary directory..."
        make install DESTDIR=${INSTALL_DIR}
        
        # 创建 Debian 包结构
        DEB_DIR=${INSTALL_DIR}/deb-package
        mkdir -p ${DEB_DIR}/DEBIAN
        mkdir -p ${DEB_DIR}/usr
        mkdir -p ${DEB_DIR}/usr/share/doc/hangover-proton
        
        # 复制文件
        cp -r ${INSTALL_DIR}/usr/* ${DEB_DIR}/usr/
        
        # 创建控制文件
        cat > ${DEB_DIR}/DEBIAN/control << CONTROL
        Package: hangover-proton
        Version: ${HOVERSION}~${CODENAME}
        Architecture: ${ARCH}
        Maintainer: GitHub Actions Build <noreply@github.com>
        Installed-Size: $(du -sk ${DEB_DIR}/usr | cut -f1)
        Depends: libc6 (>= 2.36), libgcc-s1 (>= 12), libstdc++6 (>= 12), 
                 libgl1, libvulkan1, libpulse0, libasound2 (>= 1.2.4),
                 libsdl2-2.0-0 (>= 2.0.14), libx11-6, libxext6, libxrandr2, 
                 libxinerama1, libxcursor1, libxi6, libxcomposite1, libxdamage1, 
                 libxfixes3, libxxf86vm1, libdbus-1-3 (>= 1.12), libudev1 (>= 247),
                 libv4l-0 (>= 1.22), libxkbcommon0 (>= 1.4), libxml2 (>= 2.9.13),
                 libxslt1.1 (>= 1.1.35), libgnutls30 (>= 3.7.7), libcups2 (>= 2.4),
                 libfreetype6 (>= 2.12), libfontconfig1 (>= 2.14), libglu1-mesa | libglu1,
                 libgstreamer1.0-0 (>= 1.20), libgstreamer-plugins-base1.0-0 (>= 1.20),
                 libgstreamer-plugins-bad1.0-0 (>= 1.20), libunwind8 (>= 1.5)
        Recommends: mesa-vulkan-drivers, libvulkan1, gstreamer1.0-plugins-good,
                    gstreamer1.0-plugins-bad, gstreamer1.0-plugins-ugly
        Conflicts: wine, wine64, wine-stable, wine-development, winehq-stable, winehq-devel
        Replaces: wine, wine64
        Provides: wine, wine64
        Section: contrib/games
        Priority: optional
        Homepage: https://github.com/ValveSoftware/Proton
        Description: Proton Wine ${PROTON_VERSION} for Hangover ${HOVERSION} (Debian 12 Bookworm ARM64)
         Proton is a compatibility layer for running Windows games on Linux systems.
         This package provides Proton ${PROTON_VERSION} built for Hangover ${HOVERSION}
         on Debian 12 (Bookworm) for ARM64 architecture.
        CONTROL
        
        # 创建版权文件
        cat > ${DEB_DIR}/DEBIAN/copyright << COPYRIGHT
        Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
        Upstream-Name: Proton Wine
        Upstream-Contact: https://github.com/ValveSoftware/wine
        Source: https://github.com/ValveSoftware/wine
        
        Files: *
        Copyright: Valve Corporation
        License: LGPL-2.1+
        
        License: LGPL-2.1+
         This package is free software; you can redistribute it and/or modify
         it under the terms of the GNU Lesser General Public License as published by
         the Free Software Foundation; either version 2.1 of the License, or
         (at your option) any later version.
        COPYRIGHT
        
        # 创建 postinst 脚本
        cat > ${DEB_DIR}/DEBIAN/postinst << POSTINST
        #!/bin/bash
        # Update alternatives for wine
        update-alternatives --install /usr/bin/wine wine /usr/bin/wine64 50
        update-alternatives --install /usr/bin/wineserver wineserver /usr/bin/wineserver 50
        
        # Create version file
        mkdir -p /usr/share/hangover-proton
        echo "Proton ${PROTON_VERSION} for Hangover ${HOVERSION}" > /usr/share/hangover-proton/version
        POSTINST
        
        chmod 755 ${DEB_DIR}/DEBIAN/postinst
        
        # 创建 prerm 脚本
        cat > ${DEB_DIR}/DEBIAN/prerm << PRERM
        #!/bin/bash
        # Remove alternatives
        update-alternatives --remove wine /usr/bin/wine64
        update-alternatives --remove wineserver /usr/bin/wineserver
        PRERM
        
        chmod 755 ${DEB_DIR}/DEBIAN/prerm
        
        # 生成 md5sums
        cd ${DEB_DIR}
        find usr -type f -exec md5sum {} \; > DEBIAN/md5sums
        
        # 构建 Debian 包
        dpkg-deb --build --root-owner-group ${DEB_DIR} \
            /tmp/hangover-proton_${HOVERSION}~${CODENAME}_${ARCH}.deb
        
        echo "Package built: /tmp/hangover-proton_${HOVERSION}~${CODENAME}_${ARCH}.deb"
        EOF
        
        chmod +x proton-build/build-proton.sh
        
    - name: Run Proton build in Docker container
      run: |
        cp proton-build/build-proton.sh /tmp/
        
        echo "Starting Proton build in Docker container..."
        
        # 创建测试构建脚本
        cat > /tmp/test-environment.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "=== Testing environment ==="
        echo "1. Checking compilers:"
        which gcc && gcc --version | head -1
        which g++ && g++ --version | head -1
        which clang && clang --version | head -1
        which clang++ && clang++ --version | head -1
        
        echo "2. Checking cross-compilers:"
        which aarch64-w64-mingw32-clang && aarch64-w64-mingw32-clang --version | head -1
        which llvm-ar && llvm-ar --version | head -1
        which lld && lld --version | head -1
        
        echo "3. Checking libraries:"
        echo "Freetype:"
        pkg-config --modversion freetype2
        echo "Fontconfig:"
        pkg-config --modversion fontconfig
        echo "SDL2:"
        pkg-config --modversion sdl2
        echo "Vulkan:"
        pkg-config --modversion vulkan
        
        echo "4. Testing simple compile:"
        echo '#include <stdio.h>' > test.c
        echo 'int main() { printf("Hello ARM64\\n"); return 0; }' >> test.c
        gcc test.c -o test && ./test && rm test test.c
        
        echo "=== Environment test completed ==="
        EOF
        
        chmod +x /tmp/test-environment.sh
        
        # 运行环境测试
        echo "Testing build environment..."
        docker run --rm \
          --name proton-test-env \
          --volume /tmp:/tmp:rw \
          --workdir /tmp \
          ${{ steps.foundation.outputs.foundation_image }} \
          /bin/bash -c "/tmp/test-environment.sh"
        
        # 运行正式构建
        echo "Running Proton build..."
        docker run --rm \
          --name proton-builder \
          --volume /tmp:/tmp:rw \
          --workdir /tmp \
          -e BUILD_DIR=/tmp/proton-build \
          -e INSTALL_DIR=/tmp/proton-install \
          ${{ steps.foundation.outputs.foundation_image }} \
          /bin/bash -c "
            echo '=== Starting Proton build ==='
            
            # 设置环境变量
            export LLVMMINGW_DATE=20251202
            export PATH=\"/opt/llvm-mingw/bin:\$PATH\"
            
            # 运行构建脚本
            /tmp/build-proton.sh \
              '${{ github.event.inputs.proton_branch || 'proton_10.0' }}' \
              '${{ env.HOVERSION }}' \
              '${{ env.DISTRO_CODENAME }}' \
              '${{ env.ARCH }}'
            
            echo '=== Build completed ==='
            
            # 检查是否构建成功
            if [ -f \"/tmp/hangover-proton_${{ env.HOVERSION }}~${{ env.DISTRO_CODENAME }}_${{ env.ARCH }}.deb\" ]; then
              echo 'Build successful!'
              echo 'Package details:'
              ls -lh /tmp/hangover-proton_${{ env.HOVERSION }}~${{ env.DISTRO_CODENAME }}_${{ env.ARCH }}.deb
              
              # 显示包信息
              echo 'Package info:'
              dpkg-deb -I /tmp/hangover-proton_${{ env.HOVERSION }}~${{ env.DISTRO_CODENAME }}_${{ env.ARCH }}.deb
            else
              echo 'Build failed! No package found.'
              echo 'Listing /tmp:'
              ls -la /tmp/
              exit 1
            fi
          "
        
        # 将构建的包复制到工作目录
        if [ -f "/tmp/hangover-proton_${{ env.HOVERSION }}~${{ env.DISTRO_CODENAME }}_${{ env.ARCH }}.deb" ]; then
          cp /tmp/hangover-proton_${{ env.HOVERSION }}~${{ env.DISTRO_CODENAME }}_${{ env.ARCH }}.deb .
          echo "Package copied to workspace"
        else
          echo "ERROR: Package not found in /tmp/"
          exit 1
        fi
        
    - name: Test Proton package
      run: |
        # 创建测试容器
        cat > Dockerfile.test << 'EOF'
        FROM arm64v8/debian:bookworm-slim
        
        # 设置多架构
        RUN echo "deb [arch=arm64] http://deb.debian.org/debian bookworm main contrib non-free" > /etc/apt/sources.list && \
            echo "deb [arch=arm64] http://deb.debian.org/debian bookworm-updates main contrib non-free" >> /etc/apt/sources.list && \
            echo "deb [arch=arm64] http://security.debian.org/debian-security bookworm-security main contrib non-free" >> /etc/apt/sources.list
        
        # 安装基本依赖
        RUN apt-get update && apt-get install -y \
            libgl1 \
            libvulkan1 \
            libpulse0 \
            libasound2 \
            libsdl2-2.0-0 \
            libx11-6 \
            libxext6 \
            libxrandr2 \
            libxinerama1 \
            libxcursor1 \
            libxi6 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxxf86vm1 \
            libdbus-1-3 \
            libudev1 \
            libv4l-0 \
            libxkbcommon0 \
            libxml2 \
            libxslt1.1 \
            libgnutls30 \
            libcups2 \
            libfreetype6 \
            libfontconfig1 \
            libglu1-mesa \
            libgstreamer1.0-0 \
            libgstreamer-plugins-base1.0-0 \
            libgstreamer-plugins-bad1.0-0 \
            libunwind8 \
            mesa-vulkan-drivers \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            gstreamer1.0-plugins-ugly \
            && rm -rf /var/lib/apt/lists/*
        
        # 复制 Proton 包
        COPY hangover-proton_*.deb /tmp/
        
        CMD ["/bin/bash"]
        EOF
        
        # 构建测试镜像
        docker build -t proton-test -f Dockerfile.test .
        
        # 运行测试
        docker run --rm proton-test /bin/bash -c "
          echo '=== Testing Proton package installation ==='
          
          # 安装包
          if dpkg -i /tmp/hangover-proton_*.deb 2>&1; then
            echo 'Package installed successfully'
          else
            echo 'Trying to fix dependencies...'
            apt-get update
            apt-get install -f -y
          fi
          
          # 检查是否安装成功
          echo '=== Checking installation ==='
          dpkg -l | grep hangover-proton || echo 'Package not in dpkg list'
          
          # 检查文件是否安装
          echo '=== Checking installed files ==='
          if [ -f '/usr/bin/wine64' ]; then
            echo '✓ wine64 found'
            ls -la /usr/bin/wine64
          else
            echo '✗ wine64 not found'
            ls -la /usr/bin/wine* 2>/dev/null || true
          fi
          
          if [ -f '/usr/bin/wineserver' ]; then
            echo '✓ wineserver found'
          else
            echo '✗ wineserver not found'
          fi
          
          # 测试 wine --version
          echo '=== Testing wine binary ==='
          if command -v wine64 >/dev/null 2>&1; then
            echo '✓ wine64 command found'
            echo 'Running wine64 --version:'
            timeout 10s wine64 --version 2>&1 | head -10 || echo 'wine --version failed or timed out'
          else
            echo '✗ wine64 command not found'
            exit 1
          fi
          
          echo '=== Test completed successfully ==='
        "
        
    - name: Upload Proton package artifact
      uses: actions/upload-artifact@v4
      with:
        name: hangover-proton-${{ env.HOVERSION }}-${{ env.DISTRO_CODENAME }}-${{ env.ARCH }}
        path: hangover-proton_${{ env.HOVERSION }}~${{ env.DISTRO_CODENAME }}_${{ env.ARCH }}.deb
        retention-days: 30
        
    - name: Upload as release asset
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: hangover-proton_${{ env.HOVERSION }}~${{ env.DISTRO_CODENAME }}_${{ env.ARCH }}.deb
        tag_name: ${{ github.ref }}
        
    - name: Cache foundation Docker image
      uses: actions/cache@v4
      with:
        path: foundation-debian12-arm64.tar.gz
        key: foundation-debian12-arm64-${{ hashFiles('.docker/debian12/Dockerfile') }}
        
    - name: Create build summary
      if: always()
      run: |
        echo "## Proton Wine Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- **Proton Branch:** ${{ github.event.inputs.proton_branch || 'proton_10.0' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Hangover Version:** ${{ env.HOVERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Distribution:** Debian 12 (${{ env.DISTRO_CODENAME }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Architecture:** ${{ env.ARCH }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "hangover-proton_${{ env.HOVERSION }}~${{ env.DISTRO_CODENAME }}_${{ env.ARCH }}.deb" ]; then
          PACKAGE_SIZE=$(ls -lh hangover-proton_*.deb 2>/dev/null | awk '{print $5}' || echo "unknown")
          echo "✅ **Build Status:** SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package Information:**" >> $GITHUB_STEP_SUMMARY
          echo "- **File:** hangover-proton_${{ env.HOVERSION }}~${{ env.DISTRO_CODENAME }}_${{ env.ARCH }}.deb" >> $GITHUB_STEP_SUMMARY
          echo "- **Size:** $PACKAGE_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Installation:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "sudo dpkg -i hangover-proton_${{ env.HOVERSION }}~${{ env.DISTRO_CODENAME }}_${{ env.ARCH }}.deb" >> $GITHUB_STEP_SUMMARY
          echo "# If there are dependency issues:" >> $GITHUB_STEP_SUMMARY
          echo "sudo apt-get install -f" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Build Status:** FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the build logs for details." >> $GITHUB_STEP_SUMMARY
        fi