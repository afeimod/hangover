name: Build ARM64 Wine for Debian 12

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/build-wine-arm64.yml'

jobs:
  build-wine:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        df -h

    - name: Get Wine source code
      run: |
          git clone https://github.com/wine-mirror/wine.git wine

    - name: Download patch
      run: |
        wget -O wine_do_not_create_dxgi_manager2.patch https://github.com/afeimod/linbox/raw/main/path/wine_do_not_create_dxgi_manager2.patch

    - name: Create Dockerfile
      run: |
        wget -O Dockerfile https://github.com/afeimod/linbox/raw/main/path/Dockerfile

    - name: Build Docker image
      run: |
        docker build -t wine-arm64-builder .

    - name: Run container to extract build
      run: |
        # 运行容器并提取构建好的Wine
        docker run --rm --name wine-extractor wine-arm64-builder cat /wine-arm64-debian12.tar.gz > wine-arm64-debian12.tar.gz
        
        # 列出文件大小
        ls -lh wine-arm64-debian12.tar.gz

    - name: Extract and verify
      run: |
        # 提取文件查看内容
        mkdir -p wine-extracted
        tar -tzf wine-arm64-debian12.tar.gz | head -20
        
        # 显示大小
        echo "压缩包大小:"
        du -h wine-arm64-debian12.tar.gz

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wine-arm64-debian12
        path: wine-arm64-debian12.tar.gz
        retention-days: 7

    - name: Upload as release (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: wine-arm64-debian12.tar.gz