name: deb

on:
  workflow_dispatch:
  push:
    branches:
      - '**'
    paths-ignore:
      - 'benchmarks/**'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - 'README.md'
  release:
    types: [published]

jobs:
  foundations:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [debian11, debian12, debian13, ubuntu2004, ubuntu2204, ubuntu2404]

    steps:
    - uses: actions/checkout@v1
    - name: free disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        df -h

    - name: Cache docker image
      id: cache-foundation
      uses: actions/cache@v4
      env:
        cache-name: cache-foundation
      with:
        path: foundation${{ matrix.os }}.tgz
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles(format('.packaging/{0}/Dockerfile', matrix.os)) }}
        lookup-only: true

    - name: Setup packaging
      if: ${{ steps.cache-foundation.outputs.cache-hit != 'true' }}
      run: |
        cp .packaging/${{ matrix.os }}/Dockerfile .

    - name: Build package
      if: ${{ steps.cache-foundation.outputs.cache-hit != 'true' }}
      run: docker build -t foundation${{ matrix.os }} .

    - name: Export docker image
      if: ${{ steps.cache-foundation.outputs.cache-hit != 'true' }}
      run: docker image save foundation${{ matrix.os }} | gzip -c > foundation${{ matrix.os }}.tgz

  foundations-arm:
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
        os: [ubuntu2510]

    steps:
    - uses: actions/checkout@v1
    - name: free disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        df -h

    - name: Cache docker image
      id: cache-foundation
      uses: actions/cache@v4
      env:
        cache-name: cache-foundation
      with:
        path: foundation${{ matrix.os }}.tgz
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles(format('.packaging/{0}/Dockerfile', matrix.os)) }}
        lookup-only: true

    - name: Setup packaging
      if: ${{ steps.cache-foundation.outputs.cache-hit != 'true' }}
      run: |
        cp .packaging/${{ matrix.os }}/Dockerfile .

    - name: Build package
      if: ${{ steps.cache-foundation.outputs.cache-hit != 'true' }}
      run: docker build -t foundation${{ matrix.os }} .

    - name: Export docker image
      if: ${{ steps.cache-foundation.outputs.cache-hit != 'true' }}
      run: docker image save foundation${{ matrix.os }} | gzip -c > foundation${{ matrix.os }}.tgz

  fex-pe:
    # ... 保持原样 ...
    
  fex-pe-ec:
    # ... 保持原样 ...
    
  box-pe:
    # ... 保持原样 ...
    
  dxvk:
    # ... 保持原样 ...

  proton:
    needs: foundations
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [debian11, debian12, debian13, ubuntu2004, ubuntu2204, ubuntu2404]
        include:
          - os: debian11
            codename: bullseye
          - os: debian12
            codename: bookworm
          - os: debian13
            codename: trixie
          - os: ubuntu2004
            codename: focal
          - os: ubuntu2204
            codename: jammy
          - os: ubuntu2404
            codename: noble

    steps:
    - uses: actions/checkout@v1
    - name: free disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        df -h

    - name: Cache docker image
      id: cache-foundation
      uses: actions/cache@v4
      env:
        cache-name: cache-foundation
      with:
        path: foundation${{ matrix.os }}.tgz
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles(format('.packaging/{0}/Dockerfile', matrix.os)) }}

    - name: Import docker image
      run: docker image load -i foundation${{ matrix.os }}.tgz

    - name: Get Hangover version
      id: get_version
      run: |
        VERSION=$(git describe --tags | sed 's/hangover-//')
        echo "HOVERSION=${VERSION}" >> $GITHUB_ENV
        echo "Version: ${VERSION}"
        
    - name: Clone Proton source
      run: |
        # 克隆 Valve 的 Proton 仓库，使用指定的分支（如 proton_8.0）
        git clone --depth=1 --branch proton_8.0 https://github.com/ValveSoftware/Proton.git proton-src
        
        # 或者克隆你 fork 的 Proton 仓库
        # git clone --depth=1 --branch proton-hangover https://github.com/YOUR_USERNAME/Proton.git proton-src
        
        # 提取 Proton 版本
        cd proton-src
        PROTON_VERSION=$(git describe --tags | cut -d'-' -f2)
        echo "PROTON_VERSION=${PROTON_VERSION}" >> $GITHUB_ENV
        cd ..

    - name: Setup Proton packaging
      run: |
        # 创建构建目录
        mkdir -p proton-build
        
        # 复制 Proton 源码
        cp -r proton-src/* proton-build/
        
        # 复制构建配置
        cp -r .packaging/${{ matrix.os }}/proton/* proton-build/
        
        # 设置版本号
        sed -i "s/HOVERSION/${HOVERSION}/g" proton-build/Dockerfile
        sed -i "s/PROTON_VERSION/${PROTON_VERSION}/g" proton-build/Dockerfile
        sed -i "s/HOVERSION/${HOVERSION}/g" proton-build/debian/control
        sed -i "s/PROTON_VERSION/${PROTON_VERSION}/g" proton-build/debian/control
        
        # 如果是中间构建，在版本号中添加 ~codename
        if [ "${{ github.event_name }}" != "release" ]; then
          sed -i "s/${HOVERSION}/${HOVERSION}~${{ matrix.codename }}/g" proton-build/debian/control
        fi

    - name: Generate changelog
      run: |
        cd proton-build
        
        # 生成新的 changelog 条目
        if [ "${{ github.event_name }}" == "release" ]; then
          BUILD_TYPE="Release"
        else
          BUILD_TYPE="Intermediate"
        fi
        
        cat > debian/changelog << EOF
hangover-proton (${HOVERSION}~${{ matrix.codename }}) ${{ matrix.codename }}; urgency=medium

  * ${BUILD_TYPE} build of Proton ${PROTON_VERSION} for Hangover ${HOVERSION}
  * Built for ${{ matrix.os }} (${{ matrix.codename }})

 -- GitHub Actions Build <noreply@github.com>  $(date -R)

EOF
        
        # 如果有旧的 changelog，附加在后面
        if [ -f debian/changelog.old ]; then
          cat debian/changelog.old >> debian/changelog
        fi

    - name: Build Proton package
      run: |
        cd proton-build
        docker build -t proton-${{ matrix.os }} .

    - name: Extract Proton package
      run: |
        # 从容器中提取构建好的 Debian 包
        docker run --rm proton-${{ matrix.os }} cat /opt/hangover-proton_${HOVERSION}~${{ matrix.codename }}_arm64.deb > hangover-proton_${HOVERSION}~${{ matrix.codename }}_arm64.deb
        
        # 验证包是否存在
        ls -la *.deb

    - name: Upload Proton Artifact
      uses: actions/upload-artifact@v4
      with:
        name: hangover-proton_${{ env.HOVERSION }}~${{ matrix.codename }}_arm64.deb
        path: hangover-proton_${{ env.HOVERSION }}~${{ matrix.codename }}_arm64.deb

  proton-arm:
    needs: foundations-arm
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
        os: [ubuntu2510]
        include:
          - os: ubuntu2510
            codename: questing

    steps:
    - uses: actions/checkout@v1
    - name: free disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        df -h

    - name: Cache docker image
      id: cache-foundation
      uses: actions/cache@v4
      env:
        cache-name: cache-foundation
      with:
        path: foundation${{ matrix.os }}.tgz
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles(format('.packaging/{0}/Dockerfile', matrix.os)) }}

    - name: Import docker image
      run: docker image load -i foundation${{ matrix.os }}.tgz

    - name: Get Hangover version
      id: get_version
      run: |
        VERSION=$(git describe --tags | sed 's/hangover-//')
        echo "HOVERSION=${VERSION}" >> $GITHUB_ENV
        echo "Version: ${VERSION}"

    - name: Clone Proton source
      run: |
        git clone --depth=1 --branch proton_8.0 https://github.com/ValveSoftware/Proton.git proton-src
        
        cd proton-src
        PROTON_VERSION=$(git describe --tags | cut -d'-' -f2)
        echo "PROTON_VERSION=${PROTON_VERSION}" >> $GITHUB_ENV
        cd ..

    - name: Setup Proton packaging
      run: |
        mkdir -p proton-build
        cp -r proton-src/* proton-build/
        cp -r .packaging/${{ matrix.os }}/proton/* proton-build/
        
        sed -i "s/HOVERSION/${HOVERSION}/g" proton-build/Dockerfile
        sed -i "s/PROTON_VERSION/${PROTON_VERSION}/g" proton-build/Dockerfile
        sed -i "s/HOVERSION/${HOVERSION}/g" proton-build/debian/control
        sed -i "s/PROTON_VERSION/${PROTON_VERSION}/g" proton-build/debian/control
        
        if [ "${{ github.event_name }}" != "release" ]; then
          sed -i "s/${HOVERSION}/${HOVERSION}~${{ matrix.codename }}/g" proton-build/debian/control
        fi

    - name: Generate changelog
      run: |
        cd proton-build
        
        if [ "${{ github.event_name }}" == "release" ]; then
          BUILD_TYPE="Release"
        else
          BUILD_TYPE="Intermediate"
        fi
        
        cat > debian/changelog << EOF
hangover-proton (${HOVERSION}~${{ matrix.codename }}) ${{ matrix.codename }}; urgency=medium

  * ${BUILD_TYPE} build of Proton ${PROTON_VERSION} for Hangover ${HOVERSION}
  * Built for ${{ matrix.os }} (${{ matrix.codename }})
  * ARM64 architecture

 -- GitHub Actions Build <noreply@github.com>  $(date -R)

EOF
        
        if [ -f debian/changelog.old ]; then
          cat debian/changelog.old >> debian/changelog
        fi

    - name: Build Proton package
      run: |
        cd proton-build
        docker build -t proton-${{ matrix.os }} .

    - name: Extract Proton package
      run: |
        docker run --rm proton-${{ matrix.os }} cat /opt/hangover-proton_${HOVERSION}~${{ matrix.codename }}_arm64.deb > hangover-proton_${HOVERSION}~${{ matrix.codename }}_arm64.deb
        ls -la *.deb

    - name: Upload Proton Artifact
      uses: actions/upload-artifact@v4
      with:
        name: hangover-proton_${{ env.HOVERSION }}~${{ matrix.codename }}_arm64.deb
        path: hangover-proton_${{ env.HOVERSION }}~${{ matrix.codename }}_arm64.deb

  bundle:
    needs: [dxvk, fex-pe, fex-pe-ec, box-pe, proton, proton-arm]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [debian11, debian12, debian13, ubuntu2004, ubuntu2204, ubuntu2404, ubuntu2510]
        include:
          - os: debian11
            codename: bullseye
          - os: debian12
            codename: bookworm
          - os: debian13
            codename: trixie
          - os: ubuntu2004
            codename: focal
          - os: ubuntu2204
            codename: jammy
          - os: ubuntu2404
            codename: noble
          - os: ubuntu2510
            codename: questing

    steps:
    - uses: actions/checkout@v1
    - name: free disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        df -h

    - name: Get Hangover version
      run: |
        VERSION=$(git describe --tags | sed 's/hangover-//')
        echo "HOVERSION=${VERSION}" >> $GITHUB_ENV
        echo "Version: ${VERSION}"

    - name: Download Proton Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: hangover-proton*${{ matrix.codename }}_arm64.deb
        merge-multiple: true
        path: artifacts/proton

    - name: Download FEX Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: hangover-libwow64fex*_arm64.deb
        merge-multiple: true
        path: artifacts/fex

    - name: Download FEX-EC Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: hangover-libarm64ecfex*_arm64.deb
        merge-multiple: true
        path: artifacts/fex-ec

    - name: Download DXVK Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: dxvk*.tar.gz
        merge-multiple: true
        path: artifacts/dxvk

    - name: Download Box64 Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: hangover-wowbox64*_arm64.deb
        merge-multiple: true
        path: artifacts/box64

    - name: Bundle everything
      run: |
        # 创建最终的 tarball
        tar -czf hangover-proton_${HOVERSION}_${{ matrix.os }}_${{ matrix.codename }}_arm64.tar.gz \
          artifacts/proton/*.deb \
          artifacts/fex/*.deb \
          artifacts/fex-ec/*.deb \
          artifacts/dxvk/*.tar.gz \
          artifacts/box64/*.deb
        
        # 显示包内容
        tar -tzf hangover-proton_${HOVERSION}_${{ matrix.os }}_${{ matrix.codename }}_arm64.tar.gz

    - name: Upload Bundle Artifact
      uses: actions/upload-artifact@v4
      with:
        name: hangover-proton_${{ env.HOVERSION }}_${{ matrix.os }}_${{ matrix.codename }}_arm64.tar.gz
        path: hangover-proton_${{ env.HOVERSION }}_${{ matrix.os }}_${{ matrix.codename }}_arm64.tar.gz
        retention-days: 14

    - name: Upload as Release Asset
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: hangover-proton_${{ env.HOVERSION }}_${{ matrix.os }}_${{ matrix.codename }}_arm64.tar.gz
        tag_name: ${{ github.ref }}

  dllbundle:
    needs: [dxvk, fex-pe, fex-pe-ec, box-pe]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: free disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        df -h

    - name: Get Hangover version
      run: |
        VERSION=$(git describe --tags | sed 's/hangover-//')
        echo "HOVERSION=${VERSION}" >> $GITHUB_ENV
        echo "Version: ${VERSION}"

    - name: Download DLL Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: '*.dll'
        merge-multiple: true
        path: artifacts/dlls

    - name: Download DXVK Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: dxvk*.tar.gz
        merge-multiple: true
        path: artifacts/dxvk

    - name: Bundle DLLs
      run: |
        # 创建 DLL 包
        tar -czf hangover-proton_${HOVERSION}_dlls.tar.gz \
          artifacts/dxvk/*.tar.gz \
          artifacts/dlls/*.dll
        
        # 显示包内容
        tar -tzf hangover-proton_${HOVERSION}_dlls.tar.gz

    - name: Upload DLL Bundle Artifact
      uses: actions/upload-artifact@v4
      with:
        name: hangover-proton_${{ env.HOVERSION }}_dlls.tar.gz
        path: hangover-proton_${{ env.HOVERSION }}_dlls.tar.gz
        retention-days: 14

    - name: Upload DLLs as Release Asset
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: hangover-proton_${{ env.HOVERSION }}_dlls.tar.gz
        tag_name: ${{ github.ref }}